---
title: ""
---
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{% if title %}{{ title }} · {% endif %}{{ site.name }}</title>
  <meta name="description" content="{{ description or 'Alojamiento rural acogedor a un paso de las Bardenas Reales.' }}"/>
  {% if noindex %}<meta name="robots" content="noindex">{% endif %}
  <link rel="icon" href="/favicon.ico" sizes="any">
  <link rel="apple-touch-icon" href="/images/logo-180.png">
  <link rel="manifest" href="/site.webmanifest">
  {# --- Preloads por página (LCP) --- #}
  {% if page.url == "/" %}
  <link rel="preload" as="image"
        href="/images/home-hero-1-1280.webp"
        imagesrcset="/images/home-hero-1-960.webp 960w, /images/home-hero-1-1280.webp 1280w, /images/home-hero-1-1920.webp 1920w"
        imagesizes="(max-width: 900px) 100vw, 1200px">
  {% endif %}

  {% if page.url == "/entorno/tudela/" %}
  <link rel="preload" as="image"
        href="/images/plaza-tudela-1280.webp"
        imagesrcset="/images/plaza-tudela-960.webp 960w, /images/plaza-tudela-1280.webp 1280w, /images/plaza-tudela-1920.webp 1920w"
        imagesizes="(max-width: 900px) 100vw, 1200px">
  {% endif %}

  {% if page.url == "/entorno/sendaviva/" %}
  <link rel="preload" as="image"
        href="/images/sendaviva-hero-1280.webp"
        imagesrcset="/images/sendaviva-hero-960.webp 960w, /images/sendaviva-hero-1280.webp 1280w, /images/sendaviva-hero-1920.webp 1920w"
        imagesizes="(max-width: 900px) 100vw, 1200px">
  {% endif %}

  {% if page.url == "/entorno/bardenas/" %}
  <link rel="preload" as="image"
        href="/images/bardenas-anochecer-1280.webp"
        imagesrcset="/images/bardenas-anochecer-960.webp 960w, /images/bardenas-anochecer-1280.webp 1280w, /images/bardenas-anochecer-1920.webp 1920w"
        imagesizes="(max-width: 900px) 100vw, 1200px">
  {% endif %}
  <!-- Fuentes -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Barlow:wght@400;600&family=Barlow+Condensed:wght@500;700&family=Gilda+Display&display=swap" rel="stylesheet">
  {% include "ld-website.njk" %}
  {% include "ld-webpage.njk" %}
  {% include "ld-breadcrumbs.njk" %}
  {% if page.url == "/" %}{% include "ld-lodgingbusiness.njk" %}{% endif %}
  <link rel="stylesheet" href="{{ '/assets/styles.css' | v(build) }}">
  <script src="{{ '/assets/lucide.min.js' | v(build) }}" defer></script>
  <meta name="theme-color" content="{{ site.brandColor or '#7a5c2e' }}">
  <meta property="og:image" content="{{ socialImage or '/images/logo-1200x630.png' }}">
  <meta property="og:image:width"  content="1200">
  <meta property="og:image:height" content="630">
  <meta name="twitter:card" content="summary_large_image">
</head>
<body>
  <header class="site-header" id="siteHeader">
    <div class="container nav">
      <a href="/" class="brand" aria-label="{{ site.name }} — Inicio">
        <img
          class="brand-logo"
          src="/images/logo-isotipo-64.png"
          srcset="/images/logo-64.png 1x,
                  /images/logo-192.png 3x,
                  /images/logo-512.png 8x"
          width="36" height="36" decoding="async" alt="Bardena Negra">
        <span class="brand-name font-primary">{{ site.shortName }}</span>
      </a>

      <button class="nav-toggle" id="navToggle" aria-label="Abrir menú" aria-expanded="false">
        <span></span><span></span><span></span>
      </button>

      <nav class="nav-links" id="navMenu" role="navigation" aria-label="Navegación principal">
        <a href="/">Inicio</a>

        <!-- La casa (padre + caret + submenú) -->
        <div class="nav-item has-submenu">
          <a href="/la-casa/" class="nav-link" id="link-casa">La casa</a>
          <button class="sub-toggle"
                  aria-label="Abrir submenú de La Casa"
                  aria-haspopup="menu"
                  aria-expanded="false"
                  aria-controls="submenu-casa">
            <notranslate><span class="chev" aria-hidden="true">▾</span></notranslate>
          </button>
          <div class="submenu" id="submenu-casa" role="menu" aria-labelledby="link-casa">
            <a href="/la-casa/" role="menuitem" class="parent-link only-mobile"><notranslate><strong>Ver “La casa”</strong></notranslate></a>
            <a href="/la-casa/faq/" role="menuitem">Preguntas frecuentes</a>
            <a href="/la-casa/galeria/" role="menuitem">Galería</a>
            <a href="/la-casa/equipamiento/" role="menuitem">Equipamiento</a>
          </div>
        </div>

        <!-- Entorno (padre + caret + submenú) -->
        <div class="nav-item has-submenu">
          <a href="/entorno/" class="nav-link" id="link-entorno">Entorno</a>
          <button class="sub-toggle"
                  aria-label="Abrir submenú de Entorno"
                  aria-haspopup="menu"
                  aria-expanded="false"
                  aria-controls="submenu-entorno">
            <notranslate><span class="chev" aria-hidden="true">▾</span></notranslate>
          </button>
          <div class="submenu" id="submenu-entorno" role="menu" aria-labelledby="link-entorno">
            <a href="/entorno/" role="menuitem" class="parent-link only-mobile"><notranslate><strong>Ver “Entorno”</strong></notranslate></a>
            <a href="/entorno/bardenas/" role="menuitem">Bardenas Reales</a>
            <a href="/entorno/tudela/"   role="menuitem">Tudela</a>
            <a href="/entorno/sendaviva/" role="menuitem">Sendaviva</a>
          </div>
        </div>

        <a href="/reservas/" class="cta">Reservar</a>
        <!-- Idioma (móvil) — bloque compacto y profesional -->
        <div class="lang-block" role="group" aria-labelledby="lang-title">
          <p id="lang-title" class="lang-title">Idioma</p>
          <div class="lang-seg">
            <button type="button" class="seg-btn" data-set-language="es">
              <img src="/assets/flags/es.svg" width="16" height="16" loading="lazy" decoding="async" class="flag" alt="">
              <span class="code">Español</span>
              <span class="sr-only">Español</span>
            </button>
            <button type="button" class="seg-btn" data-set-language="en">
              <img src="/assets/flags/gb.svg" width="16" height="16" loading="lazy" decoding="async" class="flag" alt="">
              <span class="code">English</span>
              <span class="sr-only">English</span>
            </button>
            <button type="button" class="seg-btn" data-set-language="fr">
              <img src="/assets/flags/fr.svg" width="16" height="16" loading="lazy" decoding="async" class="flag" alt="">
              <span class="code">Français</span>
              <span class="sr-only">Français</span>
            </button>
          </div>
        </div>
        <!-- Idiomas (ESCRITORIO) -->
        <div class="nav-item has-submenu lang-switch">
          <button class="sub-toggle" id="langToggle"
                  aria-label="Cambiar idioma" aria-haspopup="menu"
                  aria-expanded="false" aria-controls="submenu-lang">
            <img class="lang-flag" id="langCurrentFlag" src="/assets/flags/es.svg" alt="ES">
            <span class="lang-code" id="langCurrentCode">ES</span>
            <span class="chev" aria-hidden="true">▾</span>
          </button>
          <div class="submenu" id="submenu-lang" role="menu" aria-labelledby="langToggle">
            <a id="lang-es" role="menuitem"><img class="lang-flag" src="/assets/flags/es.svg" alt=""> Español</a>
            <a id="lang-en" role="menuitem"><img class="lang-flag" src="/assets/flags/gb.svg" alt=""> English</a>
            <a id="lang-fr" role="menuitem"><img class="lang-flag" src="/assets/flags/fr.svg" alt=""> Français</a>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <!-- quitamos .container del main para permitir secciones full-bleed -->
  <main id="main">
    {{ content | safe }}
  </main>

  <footer class="site-footer">
    <div class="container footer-grid">
      <!-- Col 1: Marca + dirección + contacto -->
      <div class="f-col">
        <h4 class="font-primary" style="margin:.1rem 0 .4rem">Casa Bardena Negra</h4>
        <address class="f-address">
          Calle Virgen de la Peña 44<br>
          31510 Fustiñana (Navarra), España<br>
          Licencia turística: UVTR1391
        </address>

        <div class="f-contact">
          <a class="brand-pill" href="mailto:{{ site.email or 'casaruralbardenanegra@gmail.com' }}">
            <i data-lucide="mail" aria-hidden="true"></i><span>Email: casaruralbardenanegra@gmail.com</span>
          </a>
          <a class="brand-pill" href="{{ site.instagram or 'https://www.instagram.com/casa_rural_bardena_negra' }}" target="_blank" rel="noopener">
            <i data-lucide="instagram" aria-hidden="true"></i><span>Instagram: @casa_rural_bardena_negra</span>
          </a>
          <a class="brand-pill" href="tel:+34699399285">
            <i data-lucide="phone" aria-hidden="true"></i><span>Teléfono: +34 699 39 92 85</span>
          </a>
        </div>
      </div>

      <!-- Col 2: Reserva online + plataformas -->
      <div class="f-col">
        <h5 class="font-primary" style="margin:0 0 .4rem">Reserva online</h5>
        <div class="f-cta">
          <a class="btn" href="/reservas/">Solicitar reserva</a>
          <a class="btn alt" href="{{ site.bookingHref }}" target="_blank" rel="noopener">Reservar en Rurive</a>
        </div>
        <p class="f-sub">o en cualquiera de estas plataformas:</p>
        {% set links = reviewsLink or {} %}
        <div class="f-brand-icons">
          <a class="brand-icon booking"  href="{{ links.booking  or '#' }}" target="_blank" rel="noopener ugc nofollow" aria-label="Booking"></a>
          <a class="brand-icon airbnb"   href="{{ links.airbnb   or '#' }}" target="_blank" rel="noopener ugc nofollow" aria-label="Airbnb"></a>
          <a class="brand-icon erural"   href="https://www.escapadarural.com/casa-rural/navarra/casa-bardena-negra" target="_blank" rel="noopener ugc nofollow" aria-label="EscapadaRural"></a>
          <a class="brand-icon google"   href="https://search.google.com/local/writereview?placeid=ChIJ_X7SQE43Wg0RtvVYh9tlK1g&hl=es-ES&gl=ES" target="_blank" rel="noopener" aria-label="Deja tu reseña en Google"></a>
        </div>
      </div>

      <!-- Col 3: Mapa -->
      <div class="f-col">
        <h5 class="font-primary" style="margin:0 0 .4rem">Dónde estamos</h5>
        <div class="f-map" data-consent="maps"
            data-src="https://www.google.com/maps?q=Calle+Virgen+de+la+Pe%C3%B1a+44,+31510+Fusti%C3%B1ana,+Navarra&output=embed"
            data-title="Mapa de Casa Bardena Negra">
          <div class="map-placeholder">
            <button class="btn alt sm" data-open-cc>Preferencias de cookies</button>
            <p class="map-note">
              Para ver el mapa, activa “Funcionales (mapas)”.
            </p>
          </div>
        </div>
        <p style="margin:.5rem 0 0">
          <a class="link" href="https://maps.google.com/?q=Calle+Virgen+de+la+Pe%C3%B1a+44,+Fusti%C3%B1ana" target="_blank" rel="noopener">
            Abrir en Google Maps
          </a>
        </p>
      </div>
    </div>

    <div class="container footer-bottom">
      <div>© {% if collections and (collections.all | length) %}{{ now | date('yyyy') }}{% else %}2025{% endif %} Casa Bardena Negra</div>
      <nav class="f-legal">
        <a href="/privacidad/">Privacidad</a> ·
        <a href="/legal/">Aviso legal</a> ·
        <a href="/cookies/">Cookies</a> ·
        <a href="#" data-open-cc>Preferencias de cookies</a>
      </nav>
    </div>
  </footer>

  <!-- Header scroll + menú -->
  <script>
    (function(){
      const header = document.getElementById('siteHeader');
      const toggle = document.getElementById('navToggle');
      const menu   = document.getElementById('navMenu');

      function onScroll(){ header.classList.toggle('is-scrolled', window.scrollY > 10); }
      window.addEventListener('scroll', onScroll); onScroll();

      toggle && toggle.addEventListener('click', () => {
        const open = header.classList.toggle('open');
        toggle.setAttribute('aria-expanded', open ? 'true' : 'false');
      });

      // Cierra el menú al navegar
      menu && menu.addEventListener('click', (e)=>{
        if(e.target.tagName === 'A'){ header.classList.remove('open'); toggle.setAttribute('aria-expanded','false'); }
      });
    })();
  </script>
  <!-- Lightbox (global) -->
  <div id="lightbox" class="lb-backdrop" aria-hidden="true" role="dialog" aria-label="Vista de imagen">
    <div class="lb-figure">
      <button class="lb-close" aria-label="Cerrar">×</button>
      <button class="lb-btn lb-prev" aria-label="Anterior">‹</button>
      <img id="lbImg" alt="">
      <figcaption id="lbCap" class="lb-caption"></figcaption>
      <button class="lb-btn lb-next" aria-label="Siguiente">›</button>
    </div>
  </div>

  <script>
  /* ===== Lightbox JS (ligero) ===== */
  (function(){
    const overlay = document.getElementById('lightbox');
    const img = document.getElementById('lbImg');
    const cap = document.getElementById('lbCap');
    const prevBtn = overlay.querySelector('.lb-prev');
    const nextBtn = overlay.querySelector('.lb-next');
    const closeBtn = overlay.querySelector('.lb-close');

    let items = [];  // {href, caption, el}
    let idx = 0;

    function fromAnchor(a){
      return { href:a.getAttribute('href'), caption:a.dataset.caption||'', el:a };
    }
    function collectGroup(groupName){
      const links = Array.from(document.querySelectorAll('a.lb[data-group="'+groupName+'"]'));
      return links.map(fromAnchor);
    }
    function collectVisible(){
      const grids = Array.from(document.querySelectorAll('.gallery-grid'))
        .filter(g => getComputedStyle(g).display !== 'none');
      const links = grids.flatMap(g => Array.from(g.querySelectorAll('a.lb')));
      return links.map(fromAnchor);
    }

    function openAt(i){
      idx = i;
      const it = items[idx];
      if (!it) return; // seguridad
      img.src = it.href; img.alt = it.caption || ''; cap.textContent = it.caption || '';
      overlay.classList.add('open'); overlay.removeAttribute('aria-hidden');
      document.body.style.overflow = 'hidden';

      // mostrar/ocultar flechas según cantidad
      const many = items.length > 1;
      prevBtn.style.display = many ? '' : 'none';
      nextBtn.style.display = many ? '' : 'none';
    }
    function close(){
      overlay.classList.remove('open'); overlay.setAttribute('aria-hidden','true');
      document.body.style.overflow = ''; img.src = '';
    }
    function next(){ if(items.length){ openAt((idx+1)%items.length); } }
    function prev(){ if(items.length){ openAt((idx-1+items.length)%items.length); } }

    // Delegación: clic en cualquier <a class="lb">
    document.addEventListener('click', function(e){
      const a = e.target.closest('a.lb'); if(!a) return;
      // click principal sin modificadores
      if (e.button !== 0 || e.metaKey || e.ctrlKey || e.shiftKey || e.altKey) return;
      e.preventDefault();

      const scope = document.body.dataset.lbScope || 'group'; // 'all' o 'group'

      if (scope === 'all' && a.closest('.gallery-grid')) {
        // modo “Todas” de la galería: recorrer lo visible
        items = collectVisible();
      } else if (a.dataset.group) {
        // tiene grupo: recorrer el grupo
        items = collectGroup(a.dataset.group);
      } else {
        // SIN grupo (caso imagen suelta): solo esta imagen
        items = [fromAnchor(a)];
      }

      const i = Math.max(0, items.findIndex(it => it.el === a));
      openAt(i);
    }, { passive:false });

    overlay.addEventListener('click', (e)=>{ if(e.target === overlay) close(); });
    closeBtn.addEventListener('click', close);
    nextBtn.addEventListener('click', next);
    prevBtn.addEventListener('click', prev);

    document.addEventListener('keydown', (e)=>{
      if(!overlay.classList.contains('open')) return;
      if(e.key === 'Escape') close();
      if(e.key === 'ArrowRight') next();
      if(e.key === 'ArrowLeft')  prev();
    }, true);
  })();
  </script>
  <script>
  // Submenús (PRO):
  // - MÓVIL: la fila padre togglea (no navega); el enlace al padre está dentro ("Ver sección").
  // - ESCRITORIO: hover como tenías; sin caret.
  (function(){
    const mqMobile = window.matchMedia('(max-width: 960px)');

    // Texto del padre: toggle en móvil (evita navegación accidental)
    document.querySelectorAll('.nav .has-submenu > a.nav-link').forEach(link=>{
      link.addEventListener('click', (e)=>{
        if (!mqMobile.matches) return;        // desktop: no tocamos
        e.preventDefault(); e.stopPropagation();
        const item = link.closest('.has-submenu');
        toggleItem(item);
      }, { capture:true });
    });

    // Caret: toggle en móvil + autocierra otros
    document.querySelectorAll('.sub-toggle').forEach(btn=>{
      const item = btn.closest('.has-submenu');
      btn.addEventListener('click', (e)=>{
        if (!mqMobile.matches) return;
        e.preventDefault(); e.stopPropagation();
        toggleItem(item, btn);
      });
      // Accesibilidad: Escape cierra
      item.addEventListener('keyup', (e)=>{
        if(e.key === 'Escape'){ closeItem(item); btn?.blur(); }
      });
    });

    // Click fuera: cierra todos
    document.addEventListener('click', (e)=>{
      document.querySelectorAll('.has-submenu.sub-open').forEach(item=>{
        if(!item.contains(e.target)) closeItem(item);
      });
    }, { capture:true });

    function toggleItem(item, btn){
      // cierra otros
      document.querySelectorAll('.has-submenu.sub-open').forEach(i=>{
        if (i !== item) closeItem(i);
      });
      const open = item.classList.toggle('sub-open');
      const b = btn || item.querySelector('.sub-toggle');
      b && b.setAttribute('aria-expanded', open ? 'true' : 'false');
    }
    function closeItem(item){
      item.classList.remove('sub-open');
      const b = item.querySelector('.sub-toggle');
      b && b.setAttribute('aria-expanded','false');
    }
  })();
  </script>
  <script>
  /* Activo & rama actual + auto-open en móvil */
  (function(){
    function norm(u){
      try{
        const a = document.createElement('a');
        a.href = u;
        let p = a.pathname || "/";
        p = p.replace(/\/index\.html?$/i, "");
        if (!p.endsWith("/")) p += "/";
        return p;
      }catch(e){ return "/"; }
    }
    const curr = norm(location.pathname);

    // Marca activo exacto + rama
    document.querySelectorAll('.nav a[href]').forEach(a=>{
      const href = a.getAttribute('href');
      if (!href || href.startsWith('http')) return;
      const linkPath = norm(href);

      if (curr === linkPath){
        a.classList.add('is-active');
        a.setAttribute('aria-current','page');
        const branch = a.closest('.has-submenu');
        if (branch) branch.classList.add('is-current-branch');
      }
      const isTop = a.classList.contains('nav-link') && a.closest('.has-submenu');
      if (isTop && curr.startsWith(linkPath)){
        const branch = a.closest('.has-submenu');
        branch && branch.classList.add('is-current-branch');
      }
    });

    // Auto-abrir rama actual al abrir menú (solo móvil)
    const mqMobile = window.matchMedia('(max-width: 960px)');
    function openCurrentBranchIfMobile(){
      if (!mqMobile.matches) return;
      const branch = document.querySelector('.has-submenu.is-current-branch');
      if (!branch) return;
      branch.classList.add('sub-open');
      const btn = branch.querySelector('.sub-toggle');
      btn && btn.setAttribute('aria-expanded','true');
    }
    // al cargar
    openCurrentBranchIfMobile();
    // y al pulsar hamburguesa
    const navToggle = document.getElementById('navToggle');
    navToggle && navToggle.addEventListener('click', () => {
      setTimeout(openCurrentBranchIfMobile, 0);
    });
  })();
  </script>
  <script>
  (function(){
    const mqMobile  = window.matchMedia('(max-width: 960px)');
    const header    = document.getElementById('siteHeader');
    const navToggle = document.getElementById('navToggle');

    document.addEventListener('click', (e)=>{
      if (!mqMobile.matches) return;

      // 1) Cerrar submenús abiertos si se hace tap fuera de ellos
      document.querySelectorAll('.has-submenu.sub-open').forEach(item=>{
        if (!item.contains(e.target)){
          item.classList.remove('sub-open');
          const b = item.querySelector('.sub-toggle');
          b && b.setAttribute('aria-expanded','false');
        }
      });

      // 2) Cerrar la HAMBURGUESA si se toca fuera de la cabecera
      if (header.classList.contains('open') && !header.contains(e.target)){
        header.classList.remove('open');
        navToggle && navToggle.setAttribute('aria-expanded','false');
      }
    }, {capture:true});
  })();
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      if (window.lucide) lucide.createIcons();
    });
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      if (!document.querySelector('.page-hero, .hero')) {
        document.body.classList.add('no-hero');
      }
    });
  </script>
  <script>
  (() => {
    const header = document.querySelector('header.site-header');
    if (!header) return;

    let lastY = window.scrollY;
    let idleTimer = null;
    let isHidden = false;

    const SHOW_TOP_Y = 20;        // cerca del top, nunca oculto
    const HIDE_MIN_Y = 200;       // no ocultar si aún estás muy arriba
    const HIDE_AFTER_IDLE_MS = 1200; // tiempo sin scroll para auto-ocultar
    const TOLERANCE = 6;          // ignora micro desplazamientos

    function setHidden(v){
      if (v && !isHidden){
        header.classList.add('is-hidden');
        isHidden = true;
      } else if (!v && isHidden){
        header.classList.remove('is-hidden');
        isHidden = false;
      }
    }

    function onScroll(){
      const y = window.scrollY;

      // Estado visual de "scrolled" (sombras/colores claros)
      header.classList.toggle('is-scrolled', y > 10);

      // Mostrar al subir, ocultar al bajar
      const delta = y - lastY;
      const goingDown = delta > TOLERANCE;
      const goingUp   = delta < -TOLERANCE;

      if (goingUp || y <= SHOW_TOP_Y){
        setHidden(false);
      } else if (goingDown && y > HIDE_MIN_Y && !header.classList.contains('open')){
        setHidden(true);
      }
      lastY = y;

      // Auto-ocultar tras quedarse en idle
      clearTimeout(idleTimer);
      idleTimer = setTimeout(() => {
        const yNow = window.scrollY;
        if (
          yNow > HIDE_MIN_Y &&
          !header.matches(':hover, :focus-within') &&
          !header.classList.contains('open')
        ){
          setHidden(true);
        }
      }, HIDE_AFTER_IDLE_MS);
    }

    // Mostrar si el puntero toca la parte alta (desktop)
    window.addEventListener('mousemove', (e) => {
      if (e.clientY <= 80) setHidden(false);
    }, { passive: true });

    // Mostrar al hacer foco con teclado en la cabecera
    header.addEventListener('focusin', () => setHidden(false));

    // Inicial y listeners
    onScroll();
    window.addEventListener('scroll', onScroll, { passive: true });
  })();
  </script>
<!-- Cookies: Modal preferencias -->
<div id="cc" class="cc-backdrop" aria-hidden="true" role="dialog" aria-label="Preferencias de cookies">
  <div class="cc-modal">
    <header>Preferencias de cookies</header>
    <div class="cc-body">
      <p class="cc-note">
        Usamos cookies <strong>técnicas</strong> para que la web funcione. Con tu permiso activaremos:
      </p>

      <div class="cc-switch">
        <div>
          <div class="label">Funcionales (mapas)</div>
          <div class="desc">Mostrar Google Maps embebido.</div>
        </div>
        <input type="checkbox" id="cc-func">
      </div>

      <div class="cc-switch">
        <div>
          <div class="label">Analítica</div>
          <div class="desc">Medición de uso con Google Analytics 4.</div>
        </div>
        <input type="checkbox" id="cc-ana">
      </div>

      <p class="cc-note">
        Puedes cambiar tu elección en cualquier momento desde “Preferencias de cookies”.
      </p>
    </div>
    <div class="cc-actions">
      <button class="btn cc-outline" id="cc-reject">Rechazar todo</button>
      <button class="btn alt" id="cc-save">Guardar y continuar</button>
      <button class="btn" id="cc-accept">Aceptar todo</button>
    </div>
  </div>
</div>
<!-- Cookies: Banner -->
<div id="cc-banner" class="cc-banner" aria-live="polite" hidden>
  <div class="inner">
    <p>
      Usamos cookies técnicas. Para mejorar la experiencia puedes activar
      <strong>analítica</strong> y <strong>funcionales (mapas)</strong>.
    </p>
    <div class="actions">
      <button class="btn cc-outline" id="ccb-reject">Solo técnicas</button>
      <button class="btn alt" id="ccb-prefs">Preferencias</button>
      <button class="btn" id="ccb-accept">Aceptar todo</button>
    </div>
  </div>
</div>
<script>
(function(){
  const STORE_KEY = 'cc-v1';

  const modal  = document.getElementById('cc');
  const func   = document.getElementById('cc-func');
  const ana    = document.getElementById('cc-ana');
  const banner = document.getElementById('cc-banner');

  const q  = (s, r=document) => r.querySelector(s);
  const qa = (s, r=document) => Array.from(r.querySelectorAll(s));

  /* ---------- helpers UI ---------- */
  function openModal(){ modal.classList.add('open'); modal.removeAttribute('aria-hidden'); }
  function closeModal(){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); }
  function showBanner(){ banner.hidden = false; banner.classList.add('open'); }
  function hideBanner(){ banner.classList.remove('open'); banner.hidden = true; }

  /* ---------- storage ---------- */
  function get(){ try { return JSON.parse(localStorage.getItem(STORE_KEY)||''); } catch(e){ return null; } }
  function set(v){ localStorage.setItem(STORE_KEY, JSON.stringify(v)); }

  /* ---------- mapa (on/off) ---------- */
  function placeholderHtml(){
    return `
      <div class="map-placeholder">
        <button class="btn alt sm" data-open-cc>Preferencias de cookies</button>
        <p class="map-note">Para ver el mapa, activa “Funcionales (mapas)”.</p>
      </div>`;
  }
  function loadMaps(){
    qa('[data-consent="maps"]').forEach(box=>{
      if (box.dataset.loaded) return;
      const ifr = document.createElement('iframe');
      ifr.src = box.dataset.src;
      ifr.title = box.dataset.title || 'Mapa';
      ifr.loading = 'lazy';
      ifr.referrerPolicy = 'no-referrer-when-downgrade';
      ifr.style.width = '100%';       // altura se controla por CSS (.f-map iframe)
      ifr.style.border = '0';
      box.innerHTML = '';
      box.appendChild(ifr);
      box.dataset.loaded = '1';
    });
  }
  function unloadMaps(){
    qa('[data-consent="maps"]').forEach(box=>{
      if (!box.dataset.loaded) return;
      box.innerHTML = placeholderHtml();
      delete box.dataset.loaded;
    });
  }

  /* ---------- GA (solo si hay consentimiento) ---------- */
  function loadGA(){
    if (window.__gaLoaded) return;
    const GA_ID = '{{ site.gaId or "" }}';   // <-- sin ID real, no carga nada
    if (!GA_ID || GA_ID.indexOf('G-') !== 0) return;
    window.__gaLoaded = true;
    const s1 = document.createElement('script');
    s1.async = true;
    s1.src = 'https://www.googletagmanager.com/gtag/js?id=' + GA_ID;
    const s2 = document.createElement('script');
    s2.text = `
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', '${GA_ID}', { anonymize_ip: true });
    `;
    document.head.appendChild(s1);
    document.head.appendChild(s2);
  }

  /* ---------- aplicar consentimiento ---------- */
  function apply(v){
    if (v.funcional) loadMaps(); else unloadMaps();
    if (v.analitica) loadGA();
  }

  /* ---------- banner ---------- */
  q('#ccb-accept').addEventListener('click', ()=>{
    const v = { funcional:true, analitica:true, date:Date.now() };
    set(v); apply(v); hideBanner();
  });
  q('#ccb-reject').addEventListener('click', ()=>{
    const v = { funcional:false, analitica:false, date:Date.now() };
    set(v); apply(v); hideBanner();
  });
  q('#ccb-prefs').addEventListener('click', ()=>{
    hideBanner();
    const curr = get() || { funcional:false, analitica:false };
    func.checked = !!curr.funcional;
    ana.checked  = !!curr.analitica;
    openModal();
  });

  /* ---------- modal ---------- */
  q('#cc-accept').addEventListener('click', ()=>{
    const v = { funcional:true, analitica:true, date:Date.now() };
    set(v); apply(v); closeModal();
  });
  q('#cc-save').addEventListener('click', ()=>{
    const v = { funcional:func.checked, analitica:ana.checked, date:Date.now() };
    set(v); apply(v); closeModal();
  });
  q('#cc-reject').addEventListener('click', ()=>{
    const v = { funcional:false, analitica:false, date:Date.now() };
    set(v); apply(v); closeModal();
  });

  /* Cualquier botón [data-open-cc] abre el modal (footer o placeholder) */
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-open-cc]');
    if(!btn) return;
    e.preventDefault();
    hideBanner();
    const curr = get() || { funcional:false, analitica:false };
    func.checked = !!curr.funcional;
    ana.checked  = !!curr.analitica;
    openModal();
  });

  /* ---------- init ---------- */
  const curr = get();
  if (curr){ apply(curr); } else { showBanner(); }
})();
</script>
<script>
(function(){
  const actions = document.querySelector('#cc-banner .actions');
  const reject  = document.getElementById('ccb-reject');
  if(actions && reject){
    actions.appendChild(reject);            // ahora queda el 3º (abajo)
    reject.classList.add('cc-reject');      // clase para CSS de enlace
  }
})();
</script>
<script>
(function(){
  const SUPPORTED = ['es','en','fr'];

  function stripLang(path){
    return path.replace(/^\/(en|fr)(?=\/|$)/i, '') || '/';
  }
  function ensureSlash(p){
    if (/\.[a-z0-9]+$/i.test(p)) return p; // archivo -> no tocar
    return p.endsWith('/') ? p : p + '/';
  }
  function buildUrl(lang){
    const { pathname, search, hash } = window.location;
    const rest = ensureSlash(stripLang(pathname));
    const qs = new URLSearchParams(search);
    qs.delete('lang');
    const query = qs.toString();
    const prefix = (lang === 'es') ? '' : '/' + lang;
    return prefix + rest + (query ? '?' + query : '') + hash;
  }
  function setLangprefES(){
    document.cookie = 'langpref=es; Max-Age=' + (30*86400) + '; Path=/; SameSite=Lax';
  }
  function go(lang, e){
    if (e) e.preventDefault();
    const SUPPORTED = ['es','en','fr'];
    if (!SUPPORTED.includes(lang)) return;

    const next = new URL(buildUrl(lang), window.location.origin);
    // Señal temporal para el Edge: fija cookie "lang" y redirige limpio
    next.searchParams.set('lang', lang);

    // opcional: tu cookie auxiliar para evitar rebotes de ES en otros proxies
    if (lang === 'es') setLangprefES();

    window.location.assign(next.toString());
  }

  // ESCRITORIO: enlaza y fuerza navegación
  [['es','lang-es'], ['en','lang-en'], ['fr','lang-fr']].forEach(([code, id])=>{
    const a = document.getElementById(id);
    if (!a) return;
    a.setAttribute('href', buildUrl(code));
    a.addEventListener('click', go.bind(a, code));
  });

  // MÓVIL: botones
  document.querySelectorAll('[data-set-language]').forEach(btn=>{
    btn.addEventListener('click', go.bind(btn, btn.getAttribute('data-set-language')));
  });

  // Activo en móvil (clase correcta: .lang-seg)
  const curr = (location.pathname.match(/^\/(en|fr)(?=\/|$)/i)?.[1] || 'es').toLowerCase();
  const activeBtn = document.querySelector(`.lang-seg [data-set-language="${curr}"]`);
  if (activeBtn){
    activeBtn.classList.add('is-active');
    activeBtn.setAttribute('aria-current','true');
  }

  // Sincroniza chip (bandera + código) en escritorio
  const img = document.getElementById('langCurrentFlag');
  const code = document.getElementById('langCurrentCode');
  const flagSrc = { es:'/assets/flags/es.svg', en:'/assets/flags/gb.svg', fr:'/assets/flags/fr.svg' }[curr];
  if (img && code && flagSrc){
    img.src = flagSrc;
    img.alt = curr.toUpperCase();
    code.textContent = curr.toUpperCase();
  }
})();
</script>
<script>
(function(){
  const curr = (location.pathname.match(/^\/(en|fr)(?=\/|$)/i)?.[1] || 'es').toLowerCase();
  const btn = document.querySelector('.lang-seg .seg-btn[data-set-language="'+curr+'"]');
  if (btn){ btn.classList.add('is-active'); btn.setAttribute('aria-current','true'); }
})();
</script>

</body>
</html>
